import fs from 'node:fs/promises';
import path from 'node:path';

const ROOT_DIR = process.cwd();
const PHOTOS_DIR = path.join(ROOT_DIR, 'public', 'photos');
const OUT_FILE = path.join(ROOT_DIR, 'src', 'defaultPhotos.generated.ts');

const isAllowedImage = (filename) => {
  const ext = path.extname(filename).toLowerCase();
  return ext === '.jpg' || ext === '.jpeg' || ext === '.png' || ext === '.webp';
};

const sortNames = (names) => {
  return [...names].sort((a, b) => a.localeCompare(b, 'zh-Hans-CN', { numeric: true, sensitivity: 'base' }));
};

const pickTop = (names) => {
  const preferredTop = [
    'top.jpg',
    'top.JPG',
    'top.jpeg',
    'top.JPEG',
    'top.png',
    'top.PNG',
    'top.webp',
    'top.WEBP',
    '1.jpg',
    '1.JPG',
    '1.jpeg',
    '1.JPEG',
    '1.png',
    '1.PNG',
    '1.webp',
    '1.WEBP'
  ];
  const topName = preferredTop.find((candidate) => names.includes(candidate));
  if (!topName) return names;
  return [topName, ...names.filter((name) => name !== topName)];
};

const main = async () => {
  let names = [];
  try {
    const entries = await fs.readdir(PHOTOS_DIR, { withFileTypes: true });
    names = entries
      .filter((entry) => entry.isFile())
      .map((entry) => entry.name)
      .filter(isAllowedImage);
  } catch {
    names = [];
  }

  const ordered = pickTop(sortNames(names));
  const output = `// This file is auto-generated by scripts/generate-default-photos.mjs\n` +
    `// It lists all example images under public/photos/ (used for the “使用示例” feature).\n` +
    `\n` +
    `export const DEFAULT_PHOTO_FILES = ${JSON.stringify(ordered, null, 2)} as const;\n`;

  let prev = null;
  try {
    prev = await fs.readFile(OUT_FILE, 'utf8');
  } catch {
    prev = null;
  }

  if (prev === output) return;
  await fs.writeFile(OUT_FILE, output, 'utf8');
};

main().catch((err) => {
  console.error('Failed to generate default photos list:', err);
  process.exitCode = 1;
});
